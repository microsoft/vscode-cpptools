name: $(date:yyyyMMdd)$(rev:.r)
trigger:
  branches:
    include:
    - main
    - release
    - insiders

schedules:
- cron: 30 5 * * 0
  branches:
    include:
    - main
  always: true

resources:
  repositories:
  - repository: MicroBuildTemplate
    type: git
    name: 1ESPipelineTemplates/MicroBuildTemplate
    ref: refs/tags/release

variables:
- name: Codeql.Enabled
  value: true
- name: Codeql.Language
  value: javascript

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    pool:
      name: AzurePipelines-EO
      image: 1ESPT-Windows2022
      os: windows
    sdl:
      sourceAnalysisPool:
        name: AzurePipelines-EO
        image: 1ESPT-Windows2022
        os: windows
      binskim:
        preReleaseVersion: '4.3.1'
      tsa:
        enabled: true
        config:
          tsaVersion: TsaV2
          codebase: NewOrUpdate
          codebaseName: vscode-cpptools
          tsaStamp: $(TsaProjectName)
          tsaEnvironment: PROD
          notificationAliases: $(TsaNotificationAlias)
          codebaseAdmins: $(TsaCodebaseAdmins)
          instanceUrl: $(TsaInstanceUrl)
          projectName: $(TsaProjectName)
          areaPath: $(TsaAreaPath)
          iterationPath: $(TsaIterationPath)
          alltools: true
          repositoryName: vscode-cpptools
      policheck:
        enabled: true
    featureFlags:
      autoBaseline: false

    stages:
    - stage: build
      jobs:
      - job: Phase_1
        displayName: Build cpptools.vsix
        timeoutInMinutes: 60
        cancelTimeoutInMinutes: 1
        templateContext:
          outputs:
          - output: pipelineArtifact
            displayName: 'cpptools.vsix'
            condition: succeeded()
            targetPath: $(Build.ArtifactStagingDirectory)\Extension
            artifactName: cpptools.vsix

        steps:
        - checkout: self

        - task: geeklearningio.gl-vsts-tasks-yarn.yarn-installer-task.YarnInstaller@3
          displayName: Use Yarn 1.x

        - task: UseNode@1
          displayName: Use Node 22.x
          inputs:
            version: 22.x

        - script: IF EXIST %SYSTEMDRIVE%\Users\%USERNAME%\.npmrc del %SYSTEMDRIVE%\Users\%USERNAME%\.npmrc
          displayName: Delete .npmrc if it exists

        - task: Npm@0
          displayName: Install vsce
          inputs:
            arguments: --global @vscode/vsce

        - script: mkdir $(Build.ArtifactStagingDirectory)\Extension
          displayName: Create Extension Staging Directory

        - bash: |
            TRY_COUNT=3
            EXIT_CODE=1
            for attempt in $(seq 1 $TRY_COUNT); do
              yarn run vsix-prepublish
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ]; then
                break
              fi
              if [ $attempt -lt $TRY_COUNT ]; then
                echo "Attempt $attempt/$TRY_COUNT failed, retrying in 10s..."
                sleep 10
              fi
            done
            # Check if the last command succeeded
            if [ $EXIT_CODE -ne 0 ]; then
              echo "vsix-prepublish failed after $TRY_COUNT attempts."
              exit 1
            fi
          displayName: Build files
          workingDirectory: $(Build.SourcesDirectory)/Extension

        - script: |
            cd $(Build.SourcesDirectory)\Extension
            vsce package --yarn -o $(Build.ArtifactStagingDirectory)\Extension\cpptools.vsix
          name: ProcessRunner_12
          displayName: Run VSCE to package vsix

        - task: Npm@0
          displayName: Uninstall vsce
          inputs:
            command: uninstall
            arguments: --global @vscode/vsce
