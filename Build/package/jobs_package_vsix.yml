parameters:
- name: vsixName
  type: string
  default: ''
- name: srcDir
  type: string
  default: ''
- name: signType
  type: string
  default: 'real'

jobs:
- job: package
  displayName: Build ${{ parameters.vsixName }}.vsix
  timeoutInMinutes: 30
  cancelTimeoutInMinutes: 1
  templateContext:
    mb: # Enable the MicroBuild Signing toolset
      signing:
        enabled: true
        signType: ${{ parameters.signType }}
        zipSources: false
        ${{ if eq(parameters.signType, 'real') }}:
          signWithProd: true
    featureFlags:
      autoBaseline: false
    outputs:
    - output: pipelineArtifact
      displayName: '${{ parameters.vsixName }}.vsix'
      targetPath: $(Build.ArtifactStagingDirectory)\vsix
      artifactName: vsix

  steps:
  - checkout: self

  - task: UseNode@1
    displayName: Use Node 22.x
    inputs:
      version: 22.x

  - script: npm install --global @vscode/vsce@3.1.1
    displayName: install vsce@3.1.1

  - task: geeklearningio.gl-vsts-tasks-yarn.yarn-installer-task.YarnInstaller@3
    displayName: Use Yarn 1.x

  - script: mkdir $(Build.ArtifactStagingDirectory)\vsix
    displayName: Create Staging Directory

  - script: |
      cd $(Build.SourcesDirectory)\${{ parameters.srcDir }}
      vsce package -o $(Build.ArtifactStagingDirectory)\vsix\${{ parameters.vsixName }}.vsix
    displayName: Run VSCE to package vsix

# sign the vsix
  - script: vsce generate-manifest -i $(Build.ArtifactStagingDirectory)\vsix\${{ parameters.vsixName }}.vsix -o $(Build.ArtifactStagingDirectory)\vsix\${{ parameters.vsixName }}.manifest
    displayName: generate manifest
    workingDirectory: $(Build.SourcesDirectory)\${{ parameters.srcDir }}
  - script: copy $(Build.ArtifactStagingDirectory)\vsix\${{ parameters.vsixName }}.manifest $(Build.ArtifactStagingDirectory)\vsix\${{ parameters.vsixName }}.signature.p7s
    displayName: prepare manifest for signing
    workingDirectory: $(Build.SourcesDirectory)\${{ parameters.srcDir }}
  - task: MSBuild@1
    displayName: Sign the vsix
    inputs:
      solution: $(Build.SourcesDirectory)\Build\signing\SignVsix.proj
      msbuildArguments: /p:SignType=${{ parameters.signType }}

  - script: npm uninstall --global @vscode/vsce
    displayName: uninstall vsce
