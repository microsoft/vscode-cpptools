name: $(Date:yyyyMMdd)$(rev:.r)
trigger: none
pr: none

parameters:
- name: verifyVersion
  displayName: Attest version in package.json is correct
  type: boolean
  default: false
- name: verifyChangelog
  displayName: Attest CHANGELOG.md is updated
  type: boolean
  default: false

resources:
  repositories:
  - repository: MicroBuildTemplate
    type: git
    name: 1ESPipelineTemplates/MicroBuildTemplate
    ref: refs/tags/release
  pipelines:
  - pipeline: vsixBuild
    source: '\VC\VSCode\CpptoolsVSIX\Package cpptools-themes'
    trigger: true

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    pool:
      name: AzurePipelines-EO
      image: AzurePipelinesWindows2022compliantGPT
      os: windows
    sdl:
      sourceAnalysisPool:
        name: AzurePipelines-EO
        image: AzurePipelinesWindows2022compliantGPT
        os: windows

    stages:
    - stage: Validate
      jobs:
      # Introduce pipeline compilation errors to block scheduling if the requisite parameters are not set
      - ${{ if not(eq(parameters.verifyBinariesVersion, true)) }}:
        - 'Binary version in CMakeLists.txt should be updated before scheduling the pipeline.'

      - ${{ if not(eq(parameters.verifyChangelog, true)) }}:
        - 'CHANGELOG.md should be updated before scheduling the pipeline.'

      - template: /Build/publish/jobs_manual_validation.yml@self
        parameters:
          notifyUsers: $(NotifyUsers)
          releaseBuildUrl: $(ReleaseBuildUrl)

    - stage: Release
      dependsOn: Validate
      jobs:
      - template: /Build/publish/jobs_publish_vsix.yml@self
        parameters:
          vsixName: cpptools-themes.vsix

